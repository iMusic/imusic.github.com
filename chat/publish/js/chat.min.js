/**功能还没弄好，代码写得太乱，先上传个压缩版上来**/
function Chat(){var a='<li id="user_{uin}"><img src="http://q.qlogo.cn/headimg_dl?dst_uin={uin}&spec=40" width=16 height=16><chat:nick>{nick}</chat:nick><chat:uin>({uin})</chat:uin>        </li>',b='<div class="msg-item"><img src="http://q.qlogo.cn/headimg_dl?dst_uin={uin}&spec=40" width=30 height=30><chat:nick>{nick}</chat:nick><chat:msg class="bubble_{bubble}">{msg}</chat:msg>        </div>',c='<div class="msg-item owner"><img src="http://q.qlogo.cn/headimg_dl?dst_uin={uin}&spec=40" width=30 height=30><chat:msg class="bubble_{bubble}">{msg}</chat:msg>        </div>',d=io.connect("http://chat_demo.jd-app.com/");d.emit("login",User),d.on("login",function(b){var c="";for(var d in b)c+=Fx.format(a,{uin:d,nick:b[d].nick});$(".user-list").innerHTML=c,$(".input-cnt").removeAttribute("disabled"),$(".input-cnt").focus()}),d.on("useradd",function(b){$(".user-list").innerHTML+=Fx.format(a,b)}),d.on("no-login",function(){console.log("Error!")}),d.on("logout",function(a){$("#user_"+a.uin)&&$(".user-list").removeChild($("#user_"+a.uin))}),$(".input-btn").onclick=function(){var a=$(".input-cnt").value;""!==a&&($(".input-cnt").value="",$(".input-cnt").focus(),d.emit("message",Fx.extend({},User,{msg:a})))},d.on("message",function(a){var d=a.uin===User.uin?c:b;$(".msg-cnt").innerHTML+=Fx.format(d,a),$(".msg-box").scrollTop=$(".msg-box").scrollHeight})}var $=function(a){return document.querySelector(a)},$$=function(a){return document.querySelectorAll(a)},Fx={namespace:function(a,b){b=b||window,a=a.split(".");for(var c=0;c<a.length;c++)b[a[c]]=b[a[c]]||{},b=b[a[c]];return b},extend:function(a,b){var c,d,e,f,g=arguments;for(c=1,d=g.length;d>c;c++){b=g[c];for(e in b)b.hasOwnProperty(e)&&(f=b[e],void 0!==f&&(a[e]=f))}return a},create:function(a,b){var c,d;c=a.match(/(^|\.)(\w+)$/i)[2],d=this.namespace(a.replace(/\.\w+$/,"")),d[c]=b[c],this.extend(d[c].prototype,b)},format:function(a,b){var c=1==b.length&&"object"==typeof b[0]?b[0]:b;return a.replace(/\{([\d\w]+)\}/g,function(a,b){return"undefined"!=typeof c[b]?c[b].toString():a})}};Fx.ex={isQQ:function(a){return/^[1-9]{1}\d{4,11}$/.test(a)}},Fx.create("Fx.ui.Popup",{tml:'<div class="popup-cnt">			<i class="popup-icon" data-icon="{type}"></i>			<p class="popup-txt">{text}</p>		</div>		<div class="popup-btn"></div>',Popup:function(a){var b=this,c="popup_"+(new Date).getTime();this.id=c;var d={type:"m-succ",text:"内容未定义",buttons:[new Fx.ui.Button({text:"确定",click:function(){b.remove()}})]},e=Fx.extend(d,a),f=document.createElement("div");this.el=f,f.id=c,f.className="popup-box",f.innerHTML=Fx.format(b.tml,{type:e.type,text:e.text}),document.body.appendChild(f);for(var g=f.querySelector(".popup-btn"),h=0;h<e.buttons.length;h++)g.appendChild(e.buttons[h].el)},remove:function(){document.body.removeChild(this.el)}}),Fx.create("Fx.ui.Button",{Button:function(a){var b=document.createElement("button");b.innerHTML=a.text||"",b.addEventListener("click",a.click||function(){},!1),this.el=b}});var User={uin:0,nick:"",bubble:0};!function(){function a(a){$("#J_Login").style.display="none",$("#J_Chat").style.display="block",history.replaceState({},null,"/chat/"),User.uin=a,Fx.ex.getQQ("http://zhanchen.me/api/getQQ.php?qq="+a,function(){window.getQQ=function(a){User.nick=a.nickname||"nick",Chat()}})}Fx.extend(Fx.ex,{getQQ:function(a,b){var b=b(),c=document.createElement("script");return c.src=a,document.head.appendChild(c),document.head.removeChild(c),b}}),history.replaceState({},null,"login/");var b=localStorage.user;b&&(b=JSON.parse(b),User.uin=b.uin,b.isAuto?a(b.uin):($("#J_loginAvatar").src="http://q.qlogo.cn/headimg_dl?dst_uin="+b.uin+"&spec=100",$("#J_loginUin").value=b.uin)),$("#J_loginUin").addEventListener("input",function(){var a=User.uin;this.value!==User.uin&&(a=12345),$("#J_loginAvatar").src="http://q.qlogo.cn/headimg_dl?dst_uin="+a+"&spec=100"},!1),$("#J_loginEnter").addEventListener("click",function(){var b=$("#J_loginUin").value.trim(),c=$("#J_loginAuto").checked;Fx.ex.isQQ(b)?(localStorage.setItem("user",JSON.stringify({uin:b,isAuto:c})),a(b)):new Fx.ui.Popup({type:"m-warn",text:"你没有QQ吗？",buttons:[new Fx.ui.Button({text:"是的",click:function(){location.href="http://zc.qq.com/chs/"}}),new Fx.ui.Button({text:"不是",click:function(){this.parentNode.parentNode.remove(),$("#J_loginUin").select()}})]})},!1)}();