function Chat(){function a(){var a=$(".input-cnt").value;""!==a&&($(".input-cnt").value="",$(".input-cnt").focus(),f.emit("message",Fx.extend({},User,{msg:a})))}var b='<li id="user_{uin}">			<img src="http://q.qlogo.cn/headimg_dl?dst_uin={uin}&spec=40" width=16 height=16>			<chat:nick>{nick}</chat:nick><chat:uin>({uin})</chat:uin>		</li>',c='<div class="msg-item">			<img src="http://q.qlogo.cn/headimg_dl?dst_uin={uin}&spec=40" width=30 height=30>			<chat:nick>{nick}</chat:nick>			<chat:msg class="bubble_{bubble}">{msg}</chat:msg>		</div>',d='<div class="msg-item owner">			<img src="http://q.qlogo.cn/headimg_dl?dst_uin={uin}&spec=40" width=30 height=30>			<chat:msg class="bubble_{bubble}">{msg}</chat:msg>		</div>',e=1,f=io.connect("http://chat_demo.jd-app.com/");f.emit("login",User),f.on("login",function(a){$("#J_Loader").style.display="none",$("#J_Chat").style.display="block";var c="";for(var d in a)c+=Fx.format(b,{uin:d,nick:a[d].nick});$(".user-list").innerHTML=c,$(".notice-box").innerHTML="<chat:notice>发送消息可按快捷键Ctrl+Enter或者Alt+S</chat:notice>",$(".input-cnt").removeAttribute("disabled"),$(".input-cnt").focus(),Users[User.uin]||(Users[User.uin]=User,localStorage.setItem("users",JSON.stringify(Users))),userList=a}),f.on("useradd",function(a){$(".user-list").innerHTML+=Fx.format(b,a),$(".user-list li:last-child").className="online",$(".user-list li:last-child").addEventListener("webkitAnimationEnd",function(){this.className=""},!1),config.notify&&document.hidden&&(new Fx.evt.Notify).init({title:"系统通知",message:a.nick+"("+a.uin+")上线了",image:"http://q.qlogo.cn/headimg_dl?dst_uin="+a.uin+"&spec=40",tag:3,timer:3e3}),sound.src="http://yun.365.sh/s/32718.mp3",sound.play(),userList[a.uin]=a}),f.on("no-login",function(){new Fx.ui.Popup({type:"m-warn",text:"发生错误鸟，重新登录",buttons:[new Fx.ui.Button({text:"好的",click:function(){location.reload()}})]})}),f.on("logout",function(a){$("#user_"+a.uin)&&$(".user-list").removeChild($("#user_"+a.uin)),config.notify&&document.hidden&&(new Fx.evt.Notify).init({title:"系统通知",message:userList[a.uin].nick+"("+a.uin+")下线了",image:"http://q.qlogo.cn/headimg_dl?dst_uin="+a.uin+"&spec=40",tag:3,timer:18e3})}),f.on("message",function(a){var b=a.uin===User.uin?d:c;$(".msg-cnt").innerHTML+=Fx.format(b,a),$(".msg-box").scrollTop=$(".msg-box").scrollHeight,config.notify&&document.hidden&&(e=+!e,(new Fx.evt.Notify).init({title:a.nick+"说：",message:a.msg,image:"http://q.qlogo.cn/headimg_dl?dst_uin="+a.uin+"&spec=40",tag:e+1,timer:8e3})),sound.src="http://yun.365.sh/s/32717.mp3",sound.play()}),$(".input-btn").addEventListener("click",a,!1),$(".input-cnt").addEventListener("keydown",function(b){(b.altKey&&83===b.keyCode||b.ctrlKey&&13===b.keyCode)&&a()},!1),$(".logout-btn").addEventListener("click",function(){localStorage.setItem("user",JSON.stringify({uin:User.uin,isAuto:!1})),location.reload()},!1)}var $=function(a){return document.querySelector(a)},$$=function(a){return document.querySelectorAll(a)},Fx={namespace:function(a,b){b=b||window,a=a.split(".");for(var c=0;c<a.length;c++)b[a[c]]=b[a[c]]||{},b=b[a[c]];return b},extend:function(a,b){var c,d,e,f,g=arguments;for(c=1,d=g.length;d>c;c++){b=g[c];for(e in b)b.hasOwnProperty(e)&&(f=b[e],void 0!==f&&(a[e]=f))}return a},create:function(a,b){var c,d;c=a.match(/(^|\.)(\w+)$/i)[2],d=this.namespace(a.replace(/\.\w+$/,"")),d[c]=b[c],this.extend(d[c].prototype,b)},format:function(a,b){var c=1==b.length&&"object"==typeof b[0]?b[0]:b;return a.replace(/\{([\d\w]+)\}/g,function(a,b){return"undefined"!=typeof c[b]?c[b].toString():a})}};Fx.ex={isQQ:function(a){return/^[1-9]{1}\d{4,11}$/.test(a)}},Fx.create("Fx.ui.Popup",{tml:'<div class="popup-cnt">			<i class="popup-icon" data-icon="{type}"></i>			<p class="popup-txt">{text}</p>		</div>		<div class="popup-btn"></div>',Popup:function(a){var b=this,c="popup_"+(new Date).getTime();this.id=c;var d={type:"m-succ",text:"内容未定义",buttons:[new Fx.ui.Button({text:"确定",click:function(){b.remove()}})]},e=Fx.extend(d,a),f=document.createElement("div");this.el=f,f.id=c,f.className="popup-box",f.innerHTML=Fx.format(b.tml,{type:e.type,text:e.text}),document.body.appendChild(f);for(var g=f.querySelector(".popup-btn"),h=0;h<e.buttons.length;h++)g.appendChild(e.buttons[h].el)},remove:function(){document.body.removeChild(this.el)}}),Fx.create("Fx.ui.Button",{Button:function(a){var b=document.createElement("button");b.innerHTML=a.text||"",b.addEventListener("click",a.click||function(){},!1),this.el=b}});var User={uin:0,nick:"",bubble:0},Users={},Users_tmpl='<div class="img-box">		<img src="http://q.qlogo.cn/headimg_dl?dst_uin={uin}&spec=40">	</div>	<span>{nick}</span>	<p>{uin}</p>	<i>r</i>',userList={},config={online:!0,message:!0,callme:!1,notify:!1},sound=document.createElement("audio");sound.volume=.4,function(){function a(){var a=$("#J_loginUin").value.trim(),c=$("#J_loginAuto").checked;Fx.ex.isQQ(a)?(localStorage.setItem("user",JSON.stringify({uin:a,isAuto:c})),b(a)):new Fx.ui.Popup({type:"m-warn",text:"你没有QQ吗？",buttons:[new Fx.ui.Button({text:"是的",click:function(){location.href="http://zc.qq.com/chs/"}}),new Fx.ui.Button({text:"不是",click:function(){this.parentNode.parentNode.remove(),$("#J_loginUin").select()}})]})}function b(a){$("#J_Login").style.display="none",$("#J_Loader").style.display="block",history.replaceState({},null,"/chat/"),User.uin=a,Fx.ex.getQQ("http://zhanchen.me/api/getQQ.php?qq="+a,function(){window.getQQ=function(b){User.nick=b.nickname||a,Chat()}})}Fx.extend(Fx.ex,{getQQ:function(a,b){var b=b(),c=document.createElement("script");return c.src=a,document.head.appendChild(c),document.head.removeChild(c),b}}),history.replaceState({},null,"login/");var c=localStorage.user;c&&(c=JSON.parse(c),User.uin=c.uin,c.isAuto?b(c.uin):($("#J_loginAvatar").src="http://q.qlogo.cn/headimg_dl?dst_uin="+c.uin+"&spec=100",$("#J_loginUin").value=c.uin)),Users=localStorage.users?JSON.parse(localStorage.users):{};var d=document.createDocumentFragment();for(var e in Users){var f=document.createElement("li");f.id="users_"+e,f.dataset.uin=e,f.innerHTML=Fx.format(Users_tmpl,Users[e]),d.appendChild(f)}$(".login-list").appendChild(d),$("#J_loginUin").addEventListener("input",function(){e=Users[this.value]?this.value:12345,$("#J_loginAvatar").src="http://q.qlogo.cn/headimg_dl?dst_uin="+e+"&spec=100"},!1),$("#J_loginUin").addEventListener("keydown",function(b){13===b.keyCode&&a()},!1),$("#J_loginSel").addEventListener("click",function(a){if(a.stopPropagation(),"on"==this.className)this.className="",$(".login-list").style.display="none";else if(this.className="on",$(".login-list").style.display="block",Object.keys(Users).length){for(var b=$$(".login-list li").length;b--;)$$(".login-list li")[b].className="";$("#users_"+User.uin).className="current"}else $(".login-list").style.height="50px"},!1),document.body.addEventListener("click",function(){$("#J_loginSel").className="",$(".login-list").style.display="none"},!1);var g=document.querySelector(".login-list"),h=g.querySelectorAll("li");g.addEventListener("mouseenter",function(a){"li"===a.target.tagName.toLowerCase()&&[].slice.call(h,0).forEach(function(b){b.className=b===a.target?"current":""})},!0),g.addEventListener("mousedown",function(a){if("i"===a.target.tagName.toLowerCase()){var b=a.target.parentNode,c=b.dataset.uin;return User.uin===c&&($("#J_loginAvatar").src="http://q.qlogo.cn/headimg_dl?dst_uin=12345&spec=100",$("#J_loginUin").value="",User={},localStorage.removeItem("user")),delete Users[c],localStorage.setItem("users",JSON.stringify(Users)),this.removeChild(b),!1}if("ul"===a.target.tagName.toLowerCase())return!1;var b="li"===a.target.tagName.toLowerCase()?a.target:a.target.parentNode;$("#J_loginAvatar").src="http://q.qlogo.cn/headimg_dl?dst_uin="+b.dataset.uin+"&spec=100",$("#J_loginUin").value=b.dataset.uin},!1),$("#J_loginEnter").addEventListener("click",a,!1)}(),function(){Fx.create("Fx.evt.Notify",{Notify:function(){},init:function(a){var b,c={};a=a||{},a.title=a.title||"",c.icon=a.image||null,c.body=a.message||"",c.tag=a.tag||"";try{"denied"===Notification.permission&&new Fx.ui.Popup({type:"m-warn",text:"对不起，你已关闭了chrome通知功能",buttons:[new Fx.ui.Button({text:"确认",click:function(){this.parentNode.parentNode.remove()}})]}),b=new Notification(a.title,c),"number"==typeof a.timer&&(b.onshow=function(){setTimeout(function(){b.close()},a.timer)}),b.onclick=function(){window.focus()}}catch(d){new Fx.ui.Popup({type:"m-warn",text:"你的浏览器不支持这个功能",buttons:[new Fx.ui.Button({text:"知道了",click:function(){this.parentNode.parentNode.remove()}})]})}},check:function(a){switch(Notification.permission){case"granted":if(a){var b=new Notification("我来组成头部",{body:"[测试]你是猴子请来的逗逼吗？"});b.onshow=function(){setTimeout(function(){b.close()},3e3)}}break;case"default":new Fx.ui.Popup({type:"m-warn",text:"你将开启chrome的通知功能，请在确认后点击<strong>允许</strong>按钮",buttons:[new Fx.ui.Button({text:"确认",click:function(){this.parentNode.parentNode.remove(),Notification.requestPermission(function(a){if("granted"===a){var b=new Notification("你已经开启通知功能");b.onshow=function(){setTimeout(function(){b.close()},3e3)}}})}})]});break;case"denied":$("#w_notify").checked=!1,$("#w_notify").disabled=!0,new Fx.ui.Popup({type:"m-warn",text:"对不起，你已关闭了chrome通知功能",buttons:[new Fx.ui.Button({text:"确认",click:function(){this.parentNode.parentNode.remove()}})]})}}}),localStorage.config?config=JSON.parse(localStorage.config):localStorage.config=JSON.stringify(config),$("#w_online").checked=config.online,$("#w_message").checked=config.message,$("#w_callme").checked=config.callme,$("#w_notify").checked=config.notify,$("#w_online").addEventListener("click",function(){config.online=$("#w_online").checked,localStorage.config=JSON.stringify(config)},!1),$("#w_message").addEventListener("click",function(){config.message=$("#w_message").checked,localStorage.config=JSON.stringify(config)},!1),$("#w_callme").addEventListener("click",function(){config.callme=$("#w_callme").checked,localStorage.config=JSON.stringify(config)},!1),$("#w_notify").addEventListener("click",function(){config.notify=$("#w_notify").checked,localStorage.config=JSON.stringify(config),config.notify&&(new Fx.evt.Notify).check()},!1),$("#cs_online").addEventListener("click",function(){sound.src="http://yun.365.sh/s/32718.mp3",sound.play()},!1),$("#cs_message").addEventListener("click",function(){sound.src="http://yun.365.sh/s/32717.mp3",sound.play()},!1),$("#cs_callme").addEventListener("click",function(){sound.src="http://yun.365.sh/s/32716.mp3",sound.play()},!1),$("#cs_notify").addEventListener("click",function(){(new Fx.evt.Notify).check(!0)},!1),document.addEventListener("visibilitychange",function(){},!1)}();